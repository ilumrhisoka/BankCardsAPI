<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

<th:block th:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE_URL = '/api';

        // --- Token Management ---

        function setToken(accessToken, refreshToken) {
            localStorage.setItem('accessToken', accessToken);
            localStorage.setItem('refreshToken', refreshToken);
        }

        function getToken() {
            return localStorage.getItem('accessToken');
        }

        function clearToken() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
        }

        // --- Generic API Fetcher ---

        async function apiFetch(url, method = 'GET', body = null) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json'
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const options = {
                method: method,
                headers: headers
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(API_BASE_URL + url, options);

            if (response.status === 401 || response.status === 403) {
                // Handle unauthorized access (e.g., token expired)
                clearToken();
                alert("Session expired or unauthorized. Please log in again.");
                window.location.href = '/login';
                return null;
            }

            if (!response.ok) {
                // Try to parse error message from response body
                let errorData = {};
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { message: `HTTP error! Status: ${response.status} - ${response.statusText}` };
                }
                throw new Error(errorData.message || errorData.error || 'Unknown API Error');
            }

            // Handle 204 No Content
            if (response.status === 204) {
                return {};
            }

            return response.json();
        }

        // --- Common UI Functions ---

        function showMessage(type, message) {
            const container = document.getElementById('messageContainer');
            if (!container) return;

            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            container.innerHTML = alertHtml;
        }

        function logout() {
            clearToken();
            window.location.href = '/login';
        }
    </script>
</th:block>

</body>
</html>